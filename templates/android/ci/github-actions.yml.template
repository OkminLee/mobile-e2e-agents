# Android E2E Tests Workflow
# Generated by mobile-e2e-agents
#
# This workflow runs instrumented UI tests on Android emulators.
# Supports both Espresso and Compose UI tests.

name: Android E2E Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      api_level:
        description: 'Android API level'
        required: false
        default: '33'
        type: choice
        options:
          - '30'
          - '31'
          - '33'
          - '34'

env:
  # Gradle configuration
  GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.workers.max=2"

jobs:
  # ============================================================
  # Build Job
  # ============================================================
  build:
    name: Build
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          cache-read-only: ${{ github.ref != 'refs/heads/main' }}

      - name: Build debug APK
        run: ./gradlew assembleDebug

      - name: Build test APK
        run: ./gradlew assembleDebugAndroidTest

      - name: Upload APKs
        uses: actions/upload-artifact@v4
        with:
          name: apks
          path: |
            **/build/outputs/apk/debug/*.apk
            **/build/outputs/apk/androidTest/debug/*.apk
          retention-days: 1

  # ============================================================
  # E2E Test Job
  # ============================================================
  e2e-tests:
    name: E2E Tests (API ${{ matrix.api-level }})
    needs: build
    runs-on: ubuntu-latest
    timeout-minutes: 45

    strategy:
      fail-fast: false
      matrix:
        api-level: [30, 33]
        target: [google_apis]
        include:
          - api-level: 30
            target: google_apis
            arch: x86_64
          - api-level: 33
            target: google_apis
            arch: x86_64

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Download APKs
        uses: actions/download-artifact@v4
        with:
          name: apks

      # AVD Cache for faster startup
      - name: AVD Cache
        uses: actions/cache@v4
        id: avd-cache
        with:
          path: |
            ~/.android/avd/*
            ~/.android/adb*
          key: avd-${{ matrix.api-level }}-${{ matrix.target }}-${{ matrix.arch }}

      # Create AVD if not cached
      - name: Create AVD
        if: steps.avd-cache.outputs.cache-hit != 'true'
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: ${{ matrix.api-level }}
          target: ${{ matrix.target }}
          arch: ${{ matrix.arch }}
          profile: pixel_6
          force-avd-creation: false
          emulator-options: -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim
          disable-animations: true
          script: echo "Generated AVD snapshot"

      # Run E2E Tests
      - name: Run E2E Tests
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: ${{ matrix.api-level }}
          target: ${{ matrix.target }}
          arch: ${{ matrix.arch }}
          profile: pixel_6
          force-avd-creation: false
          emulator-options: -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim
          disable-animations: true
          script: |
            # Disable animations for stability
            adb shell settings put global window_animation_scale 0
            adb shell settings put global transition_animation_scale 0
            adb shell settings put global animator_duration_scale 0

            # Run tests with retry
            ./gradlew {{MODULE}}:connectedDebugAndroidTest \
              --no-daemon \
              -Pandroid.testInstrumentationRunnerArguments.clearPackageData=true

      # Upload Test Results
      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-api${{ matrix.api-level }}
          path: |
            **/build/reports/androidTests/
            **/build/outputs/androidTest-results/

      # Upload Screenshots on Failure
      - name: Upload Failure Screenshots
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: failure-screenshots-api${{ matrix.api-level }}
          path: |
            **/build/outputs/connected_android_test_additional_output/
            **/screenshots/

  # ============================================================
  # Report Job
  # ============================================================
  report:
    name: Test Report
    needs: e2e-tests
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Download All Results
        uses: actions/download-artifact@v4
        with:
          pattern: test-results-*
          merge-multiple: true

      - name: Publish Test Report
        uses: mikepenz/action-junit-report@v4
        if: always()
        with:
          report_paths: '**/TEST-*.xml'
          fail_on_failure: true
          require_tests: true
          detailed_summary: true

      - name: Comment PR with Results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const glob = require('@actions/glob');

            // Find test result files
            const globber = await glob.create('**/TEST-*.xml');
            const files = await globber.glob();

            let passed = 0, failed = 0, skipped = 0;

            // Parse results (simplified)
            for (const file of files) {
              const content = fs.readFileSync(file, 'utf8');
              const testsMatch = content.match(/tests="(\d+)"/);
              const failuresMatch = content.match(/failures="(\d+)"/);
              const skippedMatch = content.match(/skipped="(\d+)"/);

              if (testsMatch) passed += parseInt(testsMatch[1]);
              if (failuresMatch) {
                failed += parseInt(failuresMatch[1]);
                passed -= parseInt(failuresMatch[1]);
              }
              if (skippedMatch) skipped += parseInt(skippedMatch[1]);
            }

            const emoji = failed > 0 ? '❌' : '✅';
            const body = `## ${emoji} E2E Test Results

            | Status | Count |
            |--------|-------|
            | ✅ Passed | ${passed} |
            | ❌ Failed | ${failed} |
            | ⏭️ Skipped | ${skipped} |

            ${failed > 0 ? '⚠️ Check the workflow artifacts for failure screenshots.' : ''}
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
