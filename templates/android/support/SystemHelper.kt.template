package {{PACKAGE}}.support

import android.content.Context
import android.content.Intent
import android.os.Build
import android.provider.Settings
import androidx.test.platform.app.InstrumentationRegistry
import androidx.test.uiautomator.By
import androidx.test.uiautomator.UiDevice
import androidx.test.uiautomator.UiObject2
import androidx.test.uiautomator.Until

/**
 * UI Automator helper for system-level interactions
 *
 * Use this for:
 * - System dialogs (permissions, alerts)
 * - Notifications
 * - Cross-app interactions
 * - Device controls (back, home, recent apps)
 *
 * When to use UI Automator vs Espresso:
 * - Espresso: All in-app UI interactions (preferred)
 * - UI Automator: System dialogs, notifications, cross-app testing
 *
 * Usage:
 * ```kotlin
 * // Handle permission dialog
 * SystemHelper.allowPermission()
 *
 * // Interact with notifications
 * SystemHelper.openNotifications()
 * SystemHelper.tapNotification("New message")
 *
 * // Device navigation
 * SystemHelper.pressBack()
 * SystemHelper.pressHome()
 * ```
 */
object SystemHelper {

    /**
     * UI Automator device instance
     */
    private val device: UiDevice by lazy {
        UiDevice.getInstance(InstrumentationRegistry.getInstrumentation())
    }

    /**
     * Target application context
     */
    private val context: Context by lazy {
        InstrumentationRegistry.getInstrumentation().targetContext
    }

    /**
     * Test application context
     */
    private val testContext: Context by lazy {
        InstrumentationRegistry.getInstrumentation().context
    }

    // ============================================================
    // MARK: - Permission Dialogs
    // ============================================================

    /**
     * Grant permission when system dialog appears
     */
    fun allowPermission(timeoutMs: Long = 5000): Boolean {
        val allowTexts = listOf("Allow", "허용", "ALLOW")
        return tapAnyButton(allowTexts, timeoutMs)
    }

    /**
     * Deny permission when system dialog appears
     */
    fun denyPermission(timeoutMs: Long = 5000): Boolean {
        val denyTexts = listOf("Deny", "거부", "Don't allow", "DENY")
        return tapAnyButton(denyTexts, timeoutMs)
    }

    /**
     * Handle "Allow all the time" permission option (location)
     */
    fun allowPermissionAlways(timeoutMs: Long = 5000): Boolean {
        val texts = listOf("Allow all the time", "항상 허용", "While using the app")
        return tapAnyButton(texts, timeoutMs)
    }

    /**
     * Handle "Only this time" permission option
     */
    fun allowPermissionOnce(timeoutMs: Long = 5000): Boolean {
        val texts = listOf("Only this time", "이번만 허용")
        return tapAnyButton(texts, timeoutMs)
    }

    private fun tapAnyButton(texts: List<String>, timeoutMs: Long): Boolean {
        for (text in texts) {
            val button = device.wait(Until.findObject(By.text(text)), timeoutMs / texts.size)
            if (button != null) {
                button.click()
                return true
            }
        }
        return false
    }

    // ============================================================
    // MARK: - Navigation
    // ============================================================

    /**
     * Press device back button
     */
    fun pressBack(): Boolean {
        return device.pressBack()
    }

    /**
     * Press device home button
     */
    fun pressHome(): Boolean {
        return device.pressHome()
    }

    /**
     * Open recent apps (app switcher)
     */
    fun openRecentApps(): Boolean {
        return device.pressRecentApps()
    }

    /**
     * Press Enter key
     */
    fun pressEnter(): Boolean {
        return device.pressEnter()
    }

    /**
     * Press Search key
     */
    fun pressSearch(): Boolean {
        return device.pressSearch()
    }

    // ============================================================
    // MARK: - Notifications
    // ============================================================

    /**
     * Open notification shade
     */
    fun openNotifications(): Boolean {
        return device.openNotification()
    }

    /**
     * Open quick settings panel
     */
    fun openQuickSettings(): Boolean {
        return device.openQuickSettings()
    }

    /**
     * Find and tap a notification containing text
     */
    fun tapNotification(textContains: String, timeoutMs: Long = 5000): Boolean {
        openNotifications()
        val notification = device.wait(
            Until.findObject(By.textContains(textContains)),
            timeoutMs
        )
        return notification?.let {
            it.click()
            true
        } ?: false
    }

    /**
     * Clear all notifications
     */
    fun clearAllNotifications(): Boolean {
        openNotifications()
        val clearButton = device.wait(
            Until.findObject(By.text("Clear all")),
            2000
        ) ?: device.wait(
            Until.findObject(By.text("모두 지우기")),
            1000
        )
        return clearButton?.let {
            it.click()
            true
        } ?: run {
            pressBack()
            false
        }
    }

    /**
     * Check if notification exists
     */
    fun notificationExists(textContains: String, timeoutMs: Long = 3000): Boolean {
        openNotifications()
        val exists = device.wait(
            Until.hasObject(By.textContains(textContains)),
            timeoutMs
        )
        pressBack()
        return exists
    }

    // ============================================================
    // MARK: - App Management
    // ============================================================

    /**
     * Launch app by package name
     */
    fun launchApp(packageName: String, timeoutMs: Long = 5000) {
        val intent = context.packageManager.getLaunchIntentForPackage(packageName)
        intent?.addFlags(Intent.FLAG_ACTIVITY_CLEAR_TASK or Intent.FLAG_ACTIVITY_NEW_TASK)
        context.startActivity(intent)

        device.wait(
            Until.hasObject(By.pkg(packageName).depth(0)),
            timeoutMs
        )
    }

    /**
     * Launch current app (return to foreground)
     */
    fun launchCurrentApp(timeoutMs: Long = 5000) {
        launchApp(context.packageName, timeoutMs)
    }

    /**
     * Force stop app by package name
     */
    fun forceStopApp(packageName: String) {
        executeShellCommand("am force-stop $packageName")
    }

    /**
     * Clear app data (requires test permissions)
     */
    fun clearAppData(packageName: String) {
        executeShellCommand("pm clear $packageName")
    }

    /**
     * Check if app is in foreground
     */
    fun isAppInForeground(packageName: String): Boolean {
        return device.currentPackageName == packageName
    }

    // ============================================================
    // MARK: - Screen State
    // ============================================================

    /**
     * Wake up device if screen is off
     */
    fun wakeUp() {
        if (!device.isScreenOn) {
            device.wakeUp()
        }
    }

    /**
     * Turn off screen (sleep)
     */
    fun sleep() {
        device.sleep()
    }

    /**
     * Check if screen is on
     */
    fun isScreenOn(): Boolean {
        return device.isScreenOn
    }

    /**
     * Wait for device to be idle
     */
    fun waitForIdle(timeoutMs: Long = 5000) {
        device.waitForIdle(timeoutMs)
    }

    /**
     * Wait for window update
     */
    fun waitForWindowUpdate(packageName: String?, timeoutMs: Long = 5000): Boolean {
        return device.waitForWindowUpdate(packageName, timeoutMs)
    }

    // ============================================================
    // MARK: - Text Input
    // ============================================================

    /**
     * Input text using UI Automator (useful for system dialogs)
     */
    fun inputText(element: UiObject2?, text: String) {
        element?.text = text
    }

    /**
     * Find element and input text
     */
    fun findAndInputText(
        resourceId: String,
        text: String,
        timeoutMs: Long = 5000
    ): Boolean {
        val element = device.wait(
            Until.findObject(By.res(resourceId)),
            timeoutMs
        )
        return element?.let {
            it.text = text
            true
        } ?: false
    }

    // ============================================================
    // MARK: - Screenshots
    // ============================================================

    /**
     * Take screenshot and save to file
     */
    fun takeScreenshot(filename: String): Boolean {
        val file = java.io.File(context.filesDir, "$filename.png")
        return device.takeScreenshot(file)
    }

    // ============================================================
    // MARK: - System Settings
    // ============================================================

    /**
     * Open app settings screen
     */
    fun openAppSettings() {
        val intent = Intent(Settings.ACTION_APPLICATION_DETAILS_SETTINGS).apply {
            data = android.net.Uri.fromParts("package", context.packageName, null)
            addFlags(Intent.FLAG_ACTIVITY_NEW_TASK)
        }
        context.startActivity(intent)
    }

    /**
     * Disable animations (requires ADB or test permissions)
     */
    fun disableAnimations() {
        executeShellCommand("settings put global window_animation_scale 0")
        executeShellCommand("settings put global transition_animation_scale 0")
        executeShellCommand("settings put global animator_duration_scale 0")
    }

    /**
     * Enable animations
     */
    fun enableAnimations() {
        executeShellCommand("settings put global window_animation_scale 1")
        executeShellCommand("settings put global transition_animation_scale 1")
        executeShellCommand("settings put global animator_duration_scale 1")
    }

    // ============================================================
    // MARK: - Device Info
    // ============================================================

    /**
     * Get device display width
     */
    fun getDisplayWidth(): Int = device.displayWidth

    /**
     * Get device display height
     */
    fun getDisplayHeight(): Int = device.displayHeight

    /**
     * Get device product name
     */
    fun getProductName(): String = device.productName

    /**
     * Get Android SDK version
     */
    fun getSdkVersion(): Int = Build.VERSION.SDK_INT

    // ============================================================
    // MARK: - Shell Commands
    // ============================================================

    /**
     * Execute shell command via UI Automator
     */
    fun executeShellCommand(command: String): String {
        return device.executeShellCommand(command) ?: ""
    }
}
