//
//  BaseUITest.swift
//  {{PROJECT_NAME}}UITests
//
//  Base class for all UI tests
//  Generated by mobile-e2e-agents
//

import XCTest

/// Base class for all UI tests providing common setup, teardown, and utilities
///
/// Usage:
/// ```swift
/// class LoginTests: BaseUITest {
///     override var shouldSkipOnboarding: Bool { true }
///
///     func test_loginFlow() {
///         // Your test code
///     }
/// }
/// ```
class BaseUITest: XCTestCase {

    // MARK: - Properties

    /// The application instance used throughout the test
    var app: XCUIApplication!

    /// Test configuration builder
    lazy var configuration: UITestConfiguration = {
        UITestConfiguration()
    }()

    // MARK: - Configuration Overrides

    /// Override to skip onboarding flow
    /// Default: false
    var shouldSkipOnboarding: Bool { false }

    /// Override to disable animations for faster tests
    /// Default: true
    var shouldDisableAnimations: Bool { true }

    /// Override to reset app state before each test
    /// Default: true
    var shouldResetState: Bool { true }

    /// Override to setup test data before each test
    /// Default: false
    var shouldSetupTestData: Bool { false }

    // MARK: - Lifecycle

    override func setUpWithError() throws {
        try super.setUpWithError()

        // Stop immediately when a failure occurs
        continueAfterFailure = false

        // Configure test
        configureTest()

        // Initialize and launch app
        app = XCUIApplication()
        applyConfiguration()
        app.launch()

        // Wait for app to be ready
        waitForAppToLoad()
    }

    override func tearDownWithError() throws {
        // Capture screenshot on failure
        if let failureCount = testRun?.failureCount, failureCount > 0 {
            captureScreenshot(name: "failure_\(name)")
        }

        app.terminate()
        app = nil

        try super.tearDownWithError()
    }

    // MARK: - Configuration

    /// Override to customize test configuration
    /// Called before app launch
    open func configureTest() {
        if shouldDisableAnimations {
            _ = configuration.disableAnimations()
        }

        if shouldResetState {
            _ = configuration.resetState()
        }

        if shouldSkipOnboarding {
            _ = configuration.skipOnboarding()
        }

        if shouldSetupTestData {
            _ = configuration.setupTestData()
        }
    }

    /// Apply configuration to app launch arguments and environment
    private func applyConfiguration() {
        app.launchArguments = configuration.launchArguments()
        app.launchEnvironment = configuration.launchEnvironment()
    }

    // MARK: - App State

    /// Wait for app to finish loading and be ready for interaction
    /// Override to customize wait behavior
    open func waitForAppToLoad() {
        // Default: wait for any hittable element
        let anyElement = app.descendants(matching: .any).element(boundBy: 0)
        _ = anyElement.waitForExistence(timeout: Timeout.long)

        // Additional settle time for animations
        waitForEffectsToSettle(timeout: 0.5)
    }

    /// Wait for UI effects to settle
    func waitForEffectsToSettle(timeout: TimeInterval = 0.3) {
        Thread.sleep(forTimeInterval: timeout)
    }

    // MARK: - Navigation Helpers

    /// Navigate to alarm/home tab
    func navigateToAlarmList() {
        // Override in subclass or use TabBarPage
    }

    /// Navigate to settings
    func navigateToSettings() {
        // Override in subclass or use TabBarPage
    }

    // MARK: - Screenshot

    /// Capture screenshot with given name
    func captureScreenshot(name: String) {
        let screenshot = XCUIScreen.main.screenshot()
        let attachment = XCTAttachment(screenshot: screenshot)
        attachment.name = name
        attachment.lifetime = .keepAlways
        add(attachment)
    }

    // MARK: - Debug

    /// Print current view hierarchy for debugging
    func printViewHierarchy() {
        print("=== View Hierarchy ===")
        print(app.debugDescription)
        print("======================")
    }
}

// MARK: - Timeout Constants

/// Standard timeout values for UI tests
enum Timeout {
    /// Short timeout for quick operations (2 seconds)
    static let short: TimeInterval = 2.0

    /// Medium timeout for standard operations (5 seconds)
    static let medium: TimeInterval = 5.0

    /// Long timeout for slow operations (10 seconds)
    static let long: TimeInterval = 10.0

    /// Extra long timeout for very slow operations (30 seconds)
    static let extraLong: TimeInterval = 30.0
}
